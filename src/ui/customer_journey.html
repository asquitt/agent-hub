<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AgentHub Customer Journey</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700&family=IBM+Plex+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-deep: #10243a;
        --bg-ink: #0b1929;
        --ink: #13273d;
        --ink-soft: #35516b;
        --panel: rgba(255, 255, 255, 0.9);
        --panel-line: rgba(13, 35, 56, 0.18);
        --brand: #ef6a2f;
        --sea: #1a93a5;
        --ok: #166534;
        --warn: #9a3412;
        --mono: "IBM Plex Mono", Menlo, monospace;
      }

      * {
        box-sizing: border-box;
      }

      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Outfit", "Avenir Next", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 12% 8%, rgba(239, 106, 47, 0.24) 0%, transparent 36%),
          radial-gradient(circle at 88% 0%, rgba(26, 147, 165, 0.28) 0%, transparent 40%),
          linear-gradient(170deg, var(--bg-deep) 0%, var(--bg-ink) 42%, #143750 100%);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.18;
        background-image:
          linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 28px 28px;
      }

      main {
        max-width: 1260px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 1;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 13px;
        border: 1px solid rgba(216, 240, 255, 0.24);
        background: rgba(8, 24, 40, 0.66);
        backdrop-filter: blur(8px);
        animation: rise 0.35s ease-out both;
      }

      .brand {
        color: #eff8ff;
        text-decoration: none;
        font-weight: 800;
        letter-spacing: 0.03em;
      }

      .topbar-links {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .topbar-links a {
        text-decoration: none;
        color: #e5f6ff;
        border: 1px solid rgba(216, 240, 255, 0.26);
        border-radius: 999px;
        background: rgba(8, 40, 62, 0.55);
        padding: 6px 11px;
        font-size: 0.79rem;
        font-weight: 600;
      }

      .hero {
        margin-top: 12px;
        border-radius: 20px;
        border: 1px solid rgba(221, 243, 255, 0.22);
        background: linear-gradient(166deg, rgba(13, 37, 57, 0.95) 0%, rgba(10, 86, 107, 0.9) 100%);
        color: #e7f7ff;
        padding: 18px;
        box-shadow: 0 20px 36px rgba(2, 12, 23, 0.32);
        animation: rise 0.46s ease-out both;
      }

      .hero h1 {
        margin: 0;
        font-family: "Fraunces", "Outfit", sans-serif;
        font-size: clamp(2rem, 3.8vw, 2.6rem);
        line-height: 1.04;
      }

      .hero p {
        margin: 8px 0 0;
        color: #d0e7f6;
      }

      .workspace {
        margin-top: 12px;
        display: grid;
        gap: 12px;
        grid-template-columns: 360px 1fr;
      }

      .panel {
        border-radius: 16px;
        border: 1px solid var(--panel-line);
        background: var(--panel);
        padding: 14px;
        box-shadow: 0 13px 24px rgba(4, 18, 31, 0.2);
      }

      .form-panel {
        align-self: start;
        position: sticky;
        top: 14px;
        animation: rise 0.5s ease-out both;
      }

      .warning-banner {
        margin: 0 0 12px;
        border-radius: 10px;
        border: 1px solid #fdba74;
        background: rgba(255, 237, 213, 0.94);
        color: #7c2d12;
        padding: 10px 12px;
        font-size: 0.86rem;
        font-weight: 700;
      }

      .controls {
        display: grid;
        gap: 10px;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.73rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--ink-soft);
        font-weight: 700;
      }

      input,
      button {
        border-radius: 10px;
        border: 1px solid rgba(19, 55, 84, 0.26);
        padding: 10px 11px;
        font: inherit;
      }

      input:focus {
        outline: 2px solid rgba(26, 147, 165, 0.35);
        outline-offset: 1px;
      }

      .actions {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        border: 0;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
      }

      .primary {
        background: linear-gradient(140deg, #c44f1f 0%, var(--brand) 55%, #ff965c 100%);
        box-shadow: 0 10px 18px rgba(210, 89, 38, 0.3);
      }

      .secondary {
        background: linear-gradient(140deg, #156d78 0%, var(--sea) 54%, #2cb9cb 100%);
        box-shadow: 0 10px 18px rgba(22, 111, 123, 0.29);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        min-height: 22px;
        margin: 10px 0 0;
        font-size: 0.9rem;
      }

      .status.ok {
        color: var(--ok);
      }

      .status.warn {
        color: var(--warn);
      }

      .output-shell {
        animation: rise 0.55s ease-out both;
      }

      .hero-note {
        border-radius: 14px;
        border: 1px solid rgba(218, 239, 251, 0.2);
        background: rgba(8, 30, 48, 0.58);
        color: #d4ebf8;
        padding: 12px;
        margin-bottom: 10px;
      }

      .hero-note h2 {
        margin: 0 0 8px;
        color: #f0f9ff;
        font-family: "Fraunces", "Outfit", sans-serif;
        font-size: 0.97rem;
      }

      .hero-note ul {
        margin: 0;
        padding-left: 18px;
        display: grid;
        gap: 5px;
        font-size: 0.85rem;
      }

      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
      }

      h2 {
        margin: 0 0 8px;
        font-family: "Fraunces", "Outfit", sans-serif;
        font-size: 1rem;
      }

      ol {
        margin: 0;
        padding-left: 20px;
        max-height: 340px;
        overflow: auto;
      }

      li {
        margin-bottom: 6px;
        color: #12314b;
        font-size: 0.87rem;
      }

      li.ok {
        color: var(--ok);
      }

      li.warn {
        color: var(--warn);
      }

      pre {
        margin: 0;
        max-height: 340px;
        overflow: auto;
        border-radius: 10px;
        border: 1px solid rgba(20, 62, 88, 0.35);
        background: #081a2b;
        color: #c8ebff;
        padding: 10px;
        font-size: 0.75rem;
        line-height: 1.45;
        font-family: var(--mono);
      }

      @media (max-width: 1100px) {
        .workspace {
          grid-template-columns: 1fr;
        }

        .form-panel {
          position: static;
        }
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 700px) {
        main {
          padding: 14px;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }

        .hero,
        .panel {
          padding: 13px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <nav class="topbar">
        <a class="brand" href="/">AgentHub</a>
        <div class="topbar-links">
          <a href="/">Home</a>
          <a href="/operator">Operator</a>
          <a href="/docs">API Docs</a>
        </div>
      </nav>

      <section class="hero">
        <h1>Customer Journey Console</h1>
        <p>
          End-to-end demo runner for onboarding, discovery, delegation, procurement, marketplace settlement, and
          billing reconciliation.
        </p>
      </section>

      <section class="workspace">
        <section class="panel form-panel">
          <div class="warning-banner">Demo-only workflow; requires enabled server flag and authorized principal.</div>
          <div class="controls">
            <label>
              Seller API Key
              <input id="sellerKey" value="" />
            </label>
            <label>
              Buyer API Key
              <input id="buyerKey" value="" />
            </label>
            <label>
              Admin API Key
              <input id="adminKey" value="" />
            </label>
            <label>
              Search Query
              <input id="searchQuery" value="plan pipeline" />
            </label>
            <label>
              Unit Price USD
              <input id="unitPrice" value="0.75" />
            </label>
            <label>
              Units
              <input id="units" value="4" />
            </label>
          </div>
          <div class="actions">
            <button class="primary" id="runBtn" disabled>Run Full Demo</button>
            <button class="secondary" id="resetBtn">Reset Output</button>
          </div>
          <p class="status" id="status"></p>
        </section>

        <section class="output-shell">
          <article class="hero-note">
            <h2>Runbook focus</h2>
            <ul>
              <li>Explicit API-key roles for seller, buyer, and admin flows.</li>
              <li>Deterministic step logs and JSON output for evidence capture.</li>
              <li>Replay-safe write paths with idempotency headers on mutating calls.</li>
            </ul>
          </article>

          <section class="grid">
            <article class="panel">
              <h2>Step Log</h2>
              <ol id="stepLog"></ol>
            </article>
            <article class="panel">
              <h2>Run Output</h2>
              <pre id="output">{}</pre>
            </article>
          </section>
        </section>
      </section>
    </main>

    <script>
      const runBtn = document.getElementById("runBtn");
      const resetBtn = document.getElementById("resetBtn");
      const statusOut = document.getElementById("status");
      const stepLog = document.getElementById("stepLog");
      const output = document.getElementById("output");
      const sellerKeyInput = document.getElementById("sellerKey");
      const buyerKeyInput = document.getElementById("buyerKey");
      const adminKeyInput = document.getElementById("adminKey");

      function randomSuffix() {
        const raw = crypto.randomUUID().replace(/-/g, "").slice(0, 10);
        return raw.toLowerCase();
      }

      function setStatus(kind, message) {
        statusOut.className = kind === "ok" ? "status ok" : "status warn";
        statusOut.textContent = message;
      }

      function customerKeysPresent() {
        return (
          sellerKeyInput.value.trim().length > 0 &&
          buyerKeyInput.value.trim().length > 0 &&
          adminKeyInput.value.trim().length > 0
        );
      }

      function syncRunButtonState() {
        const enabled = customerKeysPresent();
        runBtn.disabled = !enabled;
        if (!enabled) {
          setStatus("warn", "Enter seller, buyer, and admin API keys to enable the demo run.");
          return;
        }
        if (!statusOut.textContent || statusOut.textContent.startsWith("Enter seller")) {
          setStatus("ok", "Ready.");
        }
      }

      function appendStep(name, details, ok) {
        const li = document.createElement("li");
        li.className = ok ? "ok" : "warn";
        li.textContent = `${ok ? "PASS" : "FAIL"}: ${name}${details ? ` -> ${details}` : ""}`;
        stepLog.appendChild(li);
      }

      function manifestTemplate(agentSlug, version) {
        return {
          schema_version: "0.1",
          identity: {
            id: agentSlug,
            name: `Customer Journey ${agentSlug}`,
            version,
            description: "Demo agent for end-to-end customer journey validation.",
            owner: "agenthub-e2e",
            type: "orchestrator",
          },
          capabilities: [
            {
              id: "plan-pipeline",
              name: "Plan Pipeline",
              category: "orchestration",
              description: "Plans multi-agent execution pipelines.",
              input_schema: {
                type: "object",
                properties: {
                  task: { type: "string" },
                },
                required: ["task"],
                additionalProperties: false,
              },
              output_schema: {
                type: "object",
                properties: {
                  recommended_agents: {
                    type: "array",
                    items: { type: "string" },
                  },
                },
                required: ["recommended_agents"],
                additionalProperties: false,
              },
              protocols: ["MCP", "A2A"],
              permissions: ["capabilities.search"],
              idempotency_key_required: false,
              side_effect_level: "none",
            },
          ],
          interfaces: [
            {
              name: "mcp",
              protocol: "MCP",
              endpoint: "https://example.local/mcp/customer-journey-agent",
              auth: "signed_jwt",
              privileged: false,
            },
          ],
          trust: {
            minimum_trust_score: 0.75,
            allowed_trust_sources: ["first_party"],
            policy: {
              injection_protection: "strict",
              pii_handling: "deny",
              data_retention_days: 7,
              high_risk_approval_required: true,
            },
            budget_guardrails: {
              soft_alert_pct: 80,
              reauthorization_pct: 100,
              hard_stop_pct: 120,
            },
            credential_policy: {
              short_lived_credentials: true,
              max_ttl_minutes: 60,
            },
          },
          runtime: {
            execution_mode: "deterministic_workflow",
            sandbox: "container",
            max_retries: 2,
            timeout_seconds: 30,
            idempotency_required: true,
            replay_safe: true,
            observability: {
              log_privileged_actions: true,
              emit_cost_metrics: true,
              emit_latency_metrics: true,
            },
          },
        };
      }

      async function requestJson({ method, path, apiKey, runId, body, headers = {} }) {
        const httpMethod = method.toUpperCase();
        const requestHeaders = {
          "X-API-Key": apiKey,
          ...headers,
        };
        if (["POST", "PUT", "PATCH", "DELETE"].includes(httpMethod)) {
          requestHeaders["Idempotency-Key"] =
            requestHeaders["Idempotency-Key"] || `${runId}-${path.replace(/[\\/{}:?&=]/g, "_")}-${Date.now()}`;
        }
        if (body !== undefined) {
          requestHeaders["Content-Type"] = "application/json";
        }

        const response = await fetch(path, {
          method: httpMethod,
          headers: requestHeaders,
          body: body === undefined ? undefined : JSON.stringify(body),
        });

        const text = await response.text();
        let payload = null;
        if (text) {
          try {
            payload = JSON.parse(text);
          } catch (_error) {
            payload = { raw: text };
          }
        }

        if (!response.ok) {
          const detail = payload && typeof payload === "object" ? JSON.stringify(payload) : String(payload);
          throw new Error(`${httpMethod} ${path} -> ${response.status}: ${detail}`);
        }

        return payload;
      }

      function resetOutput() {
        stepLog.innerHTML = "";
        output.textContent = "{}";
        syncRunButtonState();
      }

      async function runDemo() {
        runBtn.disabled = true;
        stepLog.innerHTML = "";
        output.textContent = "{}";
        setStatus("ok", "Running full customer journey...");

        const sellerKey = document.getElementById("sellerKey").value.trim();
        const buyerKey = document.getElementById("buyerKey").value.trim();
        const adminKey = document.getElementById("adminKey").value.trim();
        const searchQuery = document.getElementById("searchQuery").value.trim() || "plan pipeline";
        const unitPrice = Number(document.getElementById("unitPrice").value);
        const units = Number(document.getElementById("units").value);

        const suffix = randomSuffix();
        const runId = `customer-e2e-${suffix}`;
        const namespace = `@cust${suffix.slice(0, 8)}`;
        const agentSlug = `customer-agent-${suffix}`;
        const accountId = `acct-${suffix.slice(0, 10)}`;

        const summary = {
          run_id: runId,
          namespace,
          account_id: accountId,
        };

        try {
          const register = await requestJson({
            method: "POST",
            path: "/v1/agents",
            apiKey: sellerKey,
            runId,
            body: {
              namespace,
              manifest: manifestTemplate(agentSlug, "1.0.0"),
            },
          });
          appendStep("Register agent v1.0.0", register.id, true);
          summary.agent_id = register.id;

          const update = await requestJson({
            method: "PUT",
            path: `/v1/agents/${encodeURIComponent(register.id)}`,
            apiKey: sellerKey,
            runId,
            body: {
              manifest: manifestTemplate(agentSlug, "1.1.0"),
            },
          });
          appendStep("Publish agent v1.1.0", update.latest_version, true);

          const search = await requestJson({
            method: "POST",
            path: "/v1/capabilities/search",
            apiKey: buyerKey,
            runId,
            body: {
              query: searchQuery,
              pagination: { mode: "offset", offset: 0, limit: 5 },
            },
          });
          appendStep("Capability search", `${(search.data || []).length} results`, true);

          const delegation = await requestJson({
            method: "POST",
            path: "/v1/delegations",
            apiKey: sellerKey,
            runId,
            body: {
              requester_agent_id: register.id,
              delegate_agent_id: register.id,
              task_spec: "Customer journey delegation",
              estimated_cost_usd: 2.0,
              max_budget_usd: 5.0,
              simulated_actual_cost_usd: 1.7,
            },
          });
          appendStep("Create delegation", delegation.delegation_id, true);
          summary.delegation_id = delegation.delegation_id;

          const dashboard = await requestJson({
            method: "GET",
            path: `/v1/operator/dashboard?agent_id=${encodeURIComponent(register.id)}&query=${encodeURIComponent(searchQuery)}`,
            apiKey: buyerKey,
            runId,
            headers: { "X-Operator-Role": "viewer" },
          });
          appendStep("Operator dashboard", `timeline=${(dashboard.sections.timeline || []).length}`, true);

          const listing = await requestJson({
            method: "POST",
            path: "/v1/marketplace/listings",
            apiKey: sellerKey,
            runId,
            body: {
              capability_ref: "@seed:data-normalizer/normalize-records",
              unit_price_usd: unitPrice,
              max_units_per_purchase: 10,
              policy_purchase_limit_usd: 10.0,
            },
          });
          appendStep("Create listing", listing.listing_id, true);

          const policyPack = await requestJson({
            method: "POST",
            path: "/v1/procurement/policy-packs",
            apiKey: adminKey,
            runId,
            body: {
              buyer: "owner-partner",
              auto_approve_limit_usd: 1.0,
              hard_stop_limit_usd: 5.0,
              allowed_sellers: ["owner-dev"],
            },
          });
          appendStep("Upsert procurement policy pack", policyPack.pack_id, true);

          const approval = await requestJson({
            method: "POST",
            path: "/v1/procurement/approvals",
            apiKey: buyerKey,
            runId,
            body: {
              buyer: "owner-partner",
              listing_id: listing.listing_id,
              units,
              estimated_total_usd: Number((units * unitPrice).toFixed(6)),
              note: "customer-journey approval request",
            },
          });
          appendStep("Request procurement approval", approval.approval_id, true);

          const decision = await requestJson({
            method: "POST",
            path: `/v1/procurement/approvals/${approval.approval_id}/decision`,
            apiKey: adminKey,
            runId,
            body: {
              decision: "approve",
              approved_max_total_usd: Number((units * unitPrice + 0.5).toFixed(6)),
              note: "approved in customer journey",
            },
          });
          appendStep("Approve procurement request", decision.status, true);

          const purchase = await requestJson({
            method: "POST",
            path: "/v1/marketplace/purchase",
            apiKey: buyerKey,
            runId,
            body: {
              listing_id: listing.listing_id,
              units,
              max_total_usd: Number((units * unitPrice + 5).toFixed(6)),
              policy_approved: true,
              procurement_approval_id: approval.approval_id,
            },
          });
          appendStep("Purchase listing", purchase.contract_id, true);
          summary.contract_id = purchase.contract_id;

          const settlement = await requestJson({
            method: "POST",
            path: `/v1/marketplace/contracts/${purchase.contract_id}/settle`,
            apiKey: buyerKey,
            runId,
            body: { units_used: units },
          });
          appendStep("Settle contract", settlement.status, true);

          const dispute = await requestJson({
            method: "POST",
            path: `/v1/marketplace/contracts/${purchase.contract_id}/disputes`,
            apiKey: buyerKey,
            runId,
            body: {
              reason: "quality variance adjustment",
              requested_amount_usd: Number((unitPrice * 0.5).toFixed(6)),
            },
          });
          appendStep("Create dispute", dispute.dispute_id, true);

          const resolved = await requestJson({
            method: "POST",
            path: `/v1/marketplace/disputes/${dispute.dispute_id}/resolve`,
            apiKey: adminKey,
            runId,
            body: {
              resolution: "approved_partial",
              approved_amount_usd: Number((unitPrice * 0.25).toFixed(6)),
            },
          });
          appendStep("Resolve dispute", resolved.status, true);

          const payout = await requestJson({
            method: "POST",
            path: `/v1/marketplace/contracts/${purchase.contract_id}/payout`,
            apiKey: adminKey,
            runId,
          });
          appendStep("Execute payout", `net=${payout.net_payout_usd}`, true);

          await requestJson({
            method: "POST",
            path: "/v1/billing/subscriptions",
            apiKey: sellerKey,
            runId,
            body: {
              account_id: accountId,
              plan_id: "journey-pro",
              monthly_fee_usd: 12.0,
              included_units: 100,
            },
          });
          appendStep("Create subscription", accountId, true);

          await requestJson({
            method: "POST",
            path: "/v1/billing/usage",
            apiKey: sellerKey,
            runId,
            body: {
              account_id: accountId,
              meter: "marketplace_calls",
              quantity: units,
              unit_price_usd: 0.35,
            },
          });
          appendStep("Record billing usage", `${units} units`, true);

          const invoice = await requestJson({
            method: "POST",
            path: "/v1/billing/invoices/generate",
            apiKey: sellerKey,
            runId,
            body: { account_id: accountId },
          });
          appendStep("Generate invoice", invoice.invoice_id, true);

          const reconcile = await requestJson({
            method: "POST",
            path: `/v1/billing/invoices/${invoice.invoice_id}/reconcile`,
            apiKey: sellerKey,
            runId,
          });
          appendStep("Reconcile invoice", `matched=${reconcile.matched}`, true);

          const replay = await requestJson({
            method: "GET",
            path: `/v1/operator/replay/${delegation.delegation_id}`,
            apiKey: buyerKey,
            runId,
            headers: { "X-Operator-Role": "viewer" },
          });
          appendStep("Load operator replay", `events=${(replay.timeline || []).length}`, true);

          const compare = await requestJson({
            method: "GET",
            path: `/v1/agents/${encodeURIComponent(register.id)}/compare/1.0.0/1.1.0`,
            apiKey: sellerKey,
            runId,
          });
          appendStep("Compare versions", compare.behavioral_diff.compatibility, true);

          summary.discovery_result_count = (search.data || []).length;
          summary.invoice_id = invoice.invoice_id;
          summary.invoice_due_usd = invoice.due_usd;
          summary.reconcile_matched = reconcile.matched;
          summary.dispute_id = dispute.dispute_id;
          summary.payout_id = payout.payout_id;
          summary.compare_risk_level = compare.behavioral_diff.risk_level;

          output.textContent = JSON.stringify(
            {
              summary,
              artifacts: {
                agent: register,
                delegation,
                listing,
                approval,
                purchase,
                payout,
                invoice,
                reconcile,
                compare,
              },
            },
            null,
            2
          );
          setStatus("ok", "Demo completed successfully.");
        } catch (error) {
          appendStep("Demo run", error.message, false);
          output.textContent = JSON.stringify({ error: error.message }, null, 2);
          setStatus("warn", "Demo failed. Review step log and output payload.");
        } finally {
          syncRunButtonState();
        }
      }

      runBtn.addEventListener("click", runDemo);
      resetBtn.addEventListener("click", resetOutput);
      sellerKeyInput.addEventListener("input", syncRunButtonState);
      buyerKeyInput.addEventListener("input", syncRunButtonState);
      adminKeyInput.addEventListener("input", syncRunButtonState);
      resetOutput();
    </script>
  </body>
</html>
