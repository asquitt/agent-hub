# Evidence: S07

## Segment
- ID: S07
- Deliverable(s): D12
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `src/discovery/__init__.py`
  - `src/discovery/service.py`
  - `src/api/app.py`
  - `src/api/models.py`
  - `.well-known/agent-card.json`
  - `docs/discovery/MCP_TOOLS.md`
  - `tests/discovery/test_discovery_api.py`
  - `tests/discovery/test_load_sla.py`
  - `Makefile`
- Summary:
  - Implemented D12 agent-native discovery service with cached low-latency contract and compatibility paths.
  - Added discovery API endpoints:
    - `POST /v1/discovery/search`
    - `POST /v1/discovery/contract-match`
    - `POST /v1/discovery/compatibility`
    - `GET /v1/discovery/mcp-tools`
    - `GET /v1/discovery/agent-manifest`
  - Added A2A Agent Card publishing endpoint via `GET /.well-known/agent-card.json`.
  - Implemented schema compatibility reporting (`input/output required` checks).
  - Implemented cost-constraint optimization in semantic ranking (`max_cost_usd` + cost-optimized score).
  - Added MCP tool declarations (`search_capabilities`, `get_agent_manifest`, `check_compatibility`).
  - Added SLA and load tests, including 1000 mixed-query load scenario with endpoint-specific p95 checks.

## Test Commands Executed
```bash
pytest tests/discovery -q
pytest tests/integration -q
pytest tests/trust -q
pytest tests/eval -q
pytest tests/capability_search -q
pytest tests/manifest -q
pytest tests/segment_s03 -q
make discovery-load
python3 - <<'PY'
import random, time, statistics
from concurrent.futures import ThreadPoolExecutor
from src.discovery.service import DISCOVERY_SERVICE

random.seed(42)

def run_contract():
    t=time.perf_counter(); DISCOVERY_SERVICE.contract_match(['invoice_text'], ['vendor','total'], 0.03); return (time.perf_counter()-t)*1000

def run_compat():
    t=time.perf_counter(); DISCOVERY_SERVICE.compatibility_report({'type':'object','required':['ticket_text','account_id','action']}, 'support-orchestrator'); return (time.perf_counter()-t)*1000

def run_sem():
    t=time.perf_counter(); DISCOVERY_SERVICE.semantic_discovery('resolve support ticket', {'min_trust_score':0.8,'max_cost_usd':0.2}); return (time.perf_counter()-t)*1000

jobs=[]
for _ in range(1000):
    r=random.random()
    if r<0.4: jobs.append(('contract', run_contract))
    elif r<0.7: jobs.append(('compat', run_compat))
    else: jobs.append(('semantic', run_sem))

res={'contract':[],'compat':[],'semantic':[]}
with ThreadPoolExecutor(max_workers=64) as ex:
    futs=[(k, ex.submit(fn)) for k,fn in jobs]
    for k,f in futs: res[k].append(f.result())

print(f"contract_p95_ms={statistics.quantiles(res['contract'], n=100)[94]:.3f}")
print(f"compat_p95_ms={statistics.quantiles(res['compat'], n=100)[94]:.3f}")
print(f"semantic_p95_ms={statistics.quantiles(res['semantic'], n=100)[94]:.3f}")
PY
pytest -q
```

## Test Results
- Passed:
  - `pytest tests/discovery -q` -> `5 passed`
  - `pytest tests/integration -q` -> `10 passed`
  - `pytest tests/trust -q` -> `2 passed`
  - `pytest tests/eval -q` -> `3 passed`
  - `pytest tests/capability_search -q` -> `15 passed`
  - `pytest tests/manifest -q` -> `9 passed`
  - `pytest tests/segment_s03 -q` -> `8 passed`
  - `make discovery-load` -> `1 passed` (`tests/discovery/test_load_sla.py`)
  - Load snapshot (1000 mixed):
    - `contract_p95_ms=0.023`
    - `compat_p95_ms=0.017`
    - `semantic_p95_ms=35.903`
  - Full suite `pytest -q` -> `52 passed`
- Failed:
  - None
- Skipped:
  - None

## Verification Evidence
- API contract validation:
  - Discovery endpoints return structured JSON optimized for agent-native consumption.
  - MCP tool declaration endpoint and A2A card endpoint validated.
- Security validation:
  - Compatibility checks enforce schema-based contract reasoning before delegation paths.
  - Discovery service keeps policy and cost constraints in request-level evaluation.
- Cost/latency validation:
  - Contract and compatibility paths satisfy `<100ms` p95 target.
  - Semantic discovery path satisfies `<300ms` p95 target.
  - 1000 mixed-query load test passes endpoint-specific SLA thresholds.
- Logs/screenshots:
  - CLI/test outputs captured in command logs; no screenshots required.

## Known Risks
- Load tests are in-process and synthetic; external network and infrastructure variability is not modeled yet.
- Discovery cache is in-memory and single-instance; distributed cache behavior is deferred.

## Next Segment Handoff
- Recommended next segment: S08
- Required context for next segment:
  - Agent-native discovery service: `src/discovery/service.py`
  - Discovery API surface in `src/api/app.py`
  - MCP + A2A artifacts: `/v1/discovery/mcp-tools`, `/.well-known/agent-card.json`
  - SLA and load baselines in `tests/discovery/`

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
