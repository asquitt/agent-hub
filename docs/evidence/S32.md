# Evidence

## Segment
- ID: S32
- Deliverable(s): Identity v2
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `src/api/auth.py`
  - `src/api/app.py`
  - `src/api/models.py`
  - `tests/auth/test_identity_v2.py`
  - `docs/session-packets/S32.md`
- Summary:
  - Added signed scoped bearer-token primitives (issue/verify with HMAC signature + expiry claims).
  - Added hybrid auth dependency supporting API key or bearer token without breaking existing API-key clients.
  - Added scope authorization dependency and enforced scopes on:
    - `POST /v1/operator/refresh` (`operator.refresh`)
    - `POST /v1/billing/invoices/{invoice_id}/refund` (`billing.refund`)
  - Added `POST /v1/auth/tokens` to mint scoped tokens from API-key-authenticated users.
  - Added auth matrix tests validating allow/deny behavior for scoped tokens.

## Test Commands Executed
```bash
pytest tests/auth/test_identity_v2.py tests/operator/test_operator_ui.py tests/billing/test_billing_api.py -q
pytest -q
```

## Test Results
- Passed:
  - `8 passed in 0.38s` (identity + privileged endpoint auth matrix)
  - `121 passed in 5.78s` (full regression)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API/contract validation:
  - Existing API-key workflows remain compatible (operator/billing suites still pass).
- Security validation:
  - Bearer token scope denial validated for missing required scopes.
  - Scoped bearer allow-path validated for operator refresh and billing refund.
  - Token signature and expiry checks implemented in `verify_scoped_token`.
- Reliability validation:
  - Full suite remains green after auth-layer changes.

## Known Risks
- Token signing key is env-based and should migrate to dedicated secret management in later segments.
- Identity v2 currently implements scoped tokens and compatibility bridge; external IdP federation remains pending.

## Next Segment Handoff
- Recommended next segment: `S33` (Policy plane v3)
- Required context for next segment:
  - Connect new identity claims/scopes into ABAC policy decisions.
  - Add signed policy decision artifacts and explainability envelope tests.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
