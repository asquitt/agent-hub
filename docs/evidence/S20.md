# Evidence

## Segment
- ID: S20
- Deliverable(s): Cost Governance v2
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `src/cost_governance/__init__.py`
  - `src/cost_governance/storage.py`
  - `src/cost_governance/service.py`
  - `src/delegation/service.py`
  - `src/discovery/service.py`
  - `src/api/app.py`
  - `tests/cost_governance/test_budget_state_machine.py`
  - `tests/cost_governance/test_metering_integration.py`
  - `docs/billing/COST_GOVERNANCE_V2.md`
  - `docs/session-packets/S20.md`
- Summary:
  - Implemented shared cost-governance service with deterministic budget state machine (`ok`, `soft_alert`, `reauthorization_required`, `hard_stop`) at 80/100/120 thresholds.
  - Added local persistent metering storage and event recorder.
  - Integrated metering into capability search/match/recommend, discovery search/contract/compatibility, delegation create, and lease promotion paths.
  - Added metering read API: `GET /v1/cost/metering`.
  - Updated delegation budget-control logic to use shared state machine output.
  - Added tests for threshold transitions, metering integration coverage, and hard-stop no-bypass behavior.

## Test Commands Executed
```bash
pytest tests/cost_governance tests/delegation tests/discovery/test_discovery_api.py tests/operator/test_operator_ui.py -q
pytest tests/capability_search/test_openapi_contract.py tests/capability_search/test_search_v2.py tests/integration/test_registry_api.py -q
```

## Test Results
- Passed:
  - `20 passed` in cost-governance/delegation/discovery/operator suite.
  - `20 passed` in capability-search + registry regression suite.
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API contract validation:
  - Cost metering read contract exercised via `GET /v1/cost/metering`.
  - Delegation and discovery responses continue returning required policy/budget fields after cost-governance integration.
- Security validation:
  - Hard-stop threshold cannot be bypassed:
    - `tests/cost_governance/test_metering_integration.py::test_budget_hard_stop_cannot_be_bypassed`.
  - Existing delegation policy boundary tests continue passing under integrated metering.
- Cost/latency validation:
  - Metering coverage validated for search + delegation + lease promotion operations in:
    - `tests/cost_governance/test_metering_integration.py::test_metering_records_search_delegation_and_install_operations`.
  - Budget threshold transition coverage in:
    - `tests/cost_governance/test_budget_state_machine.py::test_budget_state_machine_threshold_transitions`.
- Screenshots/log excerpts:
  - `pytest tests/cost_governance ... -q` -> `20 passed in 0.97s`
  - `pytest tests/capability_search ... tests/integration ... -q` -> `20 passed in 2.03s`

## Known Risks
- Metering backend is file-based and single-node; production deployment requires centralized event transport and retention policies.
- Cost attribution currently uses deterministic local estimates for some runtime tool calls; production precision requires richer token/tool telemetry ingestion.

## Next Segment Handoff
- Recommended next segment: S21
- Required context for next segment:
  - Reuse cost events emitted by S20 for trust quality/recency weighting inputs in S21 trust graph hardening.
  - Preserve S17 policy audit and S19 idempotency guarantees while extending trust anti-gaming simulations.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
