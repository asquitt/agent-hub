# Evidence

## Segment
- ID: S54
- Deliverable(s): Duplicate/orphan code consolidation and wiring
- Date: 2026-02-13

## Deep-Dive Findings
1. Duplicate idempotency handling existed in two layers for registry writes:
   - middleware-level persistent idempotency
   - route-local in-memory idempotency cache in `src/api/app.py`.
2. Orphaned idempotency symbol remained:
   - `DELEGATION_IDEMPOTENCY_CACHE` existed for test clearing but was no longer part of runtime decisions.
3. Duplicate JSON list storage primitives existed across six modules:
   - `src/marketplace/storage.py`
   - `src/procurement/storage.py`
   - `src/compliance/storage.py`
   - `src/federation/storage.py`
   - `src/trust/storage.py`
   - `src/eval/storage.py`
4. Duplicate UTC/time helpers were repeated across many service modules.
5. Registry store lived under API package despite domain-level use, creating boundary inversion:
   - domain modules indirectly relied on `src/api/store.py`.
6. Orphaned model symbol:
   - `AgentVersionResponse` in `src/api/models.py` had no runtime/test references.

## Remediation Implemented
- Idempotency dedup:
  - Removed route-local idempotency caches for agent register/fork/update/delete in `src/api/app.py`.
  - Kept delegation on domain-specific durable idempotency path and marked `/v1/delegations` idempotency-optional in middleware policy (`src/api/access_policy.py`) to avoid double application.
  - Removed orphan runtime cache symbol and related test references (`DELEGATION_IDEMPOTENCY_CACHE`).
- Shared storage utility:
  - Added `src/common/json_store.py` and rewired duplicate JSON list modules to use it.
- Shared time utility:
  - Added `src/common/time.py` and rewired repeated UTC helper logic across service modules.
  - Preserved compatibility wrappers in knowledge/lease modules for monkeypatch-based tests.
- Boundary wiring:
  - Moved canonical registry store implementation to `src/registry/store.py`.
  - Converted `src/api/store.py` to compatibility shim re-exporting canonical registry symbols.
  - Updated registry catalog/app imports to canonical registry store path.
- Orphan cleanup:
  - Removed `AgentVersionResponse` from `src/api/models.py`.
  - Removed stale `idempotency_cache` state from registry store and launch tooling cleanup calls.

## Files Changed
- Core:
  - `src/api/access_policy.py`
  - `src/api/app.py`
  - `src/api/auth.py`
  - `src/api/models.py`
  - `src/api/store.py`
  - `src/registry/store.py`
  - `src/registry/catalog.py`
  - `src/registry/__init__.py`
  - `src/common/json_store.py`
  - `src/common/time.py`
  - `src/common/__init__.py`
- Storage/service consolidation:
  - `src/marketplace/storage.py`
  - `src/procurement/storage.py`
  - `src/compliance/storage.py`
  - `src/federation/storage.py`
  - `src/trust/storage.py`
  - `src/eval/storage.py`
  - `src/billing/service.py`
  - `src/compliance/service.py`
  - `src/cost_governance/service.py`
  - `src/delegation/service.py`
  - `src/devhub/service.py`
  - `src/eval/runner.py`
  - `src/federation/gateway.py`
  - `src/knowledge/service.py`
  - `src/lease/service.py`
  - `src/marketplace/service.py`
  - `src/procurement/service.py`
  - `src/provenance/service.py`
- Tests/tools:
  - `tests/delegation/test_delegation_api.py`
  - `tests/delegation/test_contract_v2.py`
  - `tests/cost_governance/test_metering_integration.py`
  - `tests/reliability/test_sre_controls_s37.py`
  - `tests/gate/test_architecture_guardrails_s53.py`
  - `tools/launch/check_launch_readiness.py`
  - `tools/launch/rehearse_ga_candidate.py`

## Test Commands Executed
```bash
python -m py_compile src/api/app.py src/api/auth.py src/api/store.py src/registry/store.py src/registry/catalog.py src/registry/__init__.py src/common/time.py src/common/json_store.py src/marketplace/storage.py src/procurement/storage.py src/compliance/storage.py src/federation/storage.py src/trust/storage.py src/eval/storage.py src/cost_governance/service.py src/procurement/service.py src/devhub/service.py src/provenance/service.py src/federation/gateway.py src/delegation/service.py src/marketplace/service.py src/compliance/service.py src/eval/runner.py src/billing/service.py src/knowledge/service.py src/lease/service.py tests/delegation/test_delegation_api.py tests/delegation/test_contract_v2.py tests/cost_governance/test_metering_integration.py tests/reliability/test_sre_controls_s37.py tests/gate/test_architecture_guardrails_s53.py
pytest -q tests/knowledge/test_knowledge_api.py tests/lease/test_lease_api.py tests/gate/test_architecture_guardrails_s53.py tests/delegation/test_delegation_api.py tests/cost_governance/test_metering_integration.py tests/reliability/test_sre_controls_s37.py tests/integration/test_registry_api.py tests/discovery/test_discovery_api.py tests/auth/test_access_enforcement_s53.py
pytest -q
```

## Test Results
- Passed:
  - Targeted consolidation/regression bundle: `48 passed`.
  - Full regression: `180 passed, 2 warnings`.
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- No remaining repo references to removed orphan cache symbol:
  - `DELEGATION_IDEMPOTENCY_CACHE` → zero references.
- No remaining non-API imports of `src.api`:
  - architecture guardrail passes.
- Shared utility adoption:
  - JSON-list backed modules now call `src/common/json_store.py`.
  - service time generation now routes through `src/common/time.py`.
- Registry boundary wiring:
  - canonical implementation resides in `src/registry/store.py`.
  - `src/api/store.py` is compatibility-only shim.

## Known Risks
- Startup hook deprecation warning remains (`@app.on_event("startup")`); not part of this segment’s duplicate/orphan scope.

## Next Segment Handoff
- Recommended next segment: `S55` (API router decomposition + lifespan migration).
- Required context:
  - Duplicate/orphan debt around idempotency and storage/time utilities is now materially reduced.
  - Architecture boundary guardrail baseline is stricter (no non-API `src.api` imports).

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
