# Evidence

## Segment
- ID: S59
- Deliverable(s): Runtime persistence unification wave (marketplace/procurement/trust/eval/compliance/federation + lease/knowledge durability)
- Date: 2026-02-13

## Code Changes
- Files changed:
  - `src/common/sqlite_collections.py`
  - `src/marketplace/storage.py`
  - `src/procurement/storage.py`
  - `src/trust/storage.py`
  - `src/eval/storage.py`
  - `src/compliance/storage.py`
  - `src/federation/storage.py`
  - `src/lease/storage.py`
  - `src/lease/service.py`
  - `src/knowledge/storage.py`
  - `src/knowledge/service.py`
  - `tools/launch/rehearse_ga_candidate.py`
  - `tests/lease/test_lease_api.py`
  - `tests/knowledge/test_knowledge_api.py`
  - `tests/launch/test_ga_rehearsal_s52.py`
  - `tests/persistence/test_runtime_domain_persistence_s59.py`
  - `playwright.config.js`
  - `docs/session-packets/S59.md`
- Summary:
  - Added shared SQLite collection persistence utility with per-db locking, legacy JSON bootstrap, connection reuse, and read/write cache invalidation.
  - Migrated runtime storage modules for marketplace/procurement/trust/eval/compliance/federation from JSON files to SQLite-backed collections.
  - Replaced in-memory lease and knowledge maps with durable storage modules and added test reset helpers.
  - Updated launch rehearsal tooling and related tests to use durable reset paths instead of in-memory globals.
  - Added S59 persistence regression tests validating legacy bootstrap migration + durability behavior.
  - Added Playwright runtime db env configuration for migrated domains.

## Test Commands Executed
```bash
python3 -m py_compile src/common/sqlite_collections.py src/marketplace/storage.py src/procurement/storage.py src/trust/storage.py src/eval/storage.py src/compliance/storage.py src/federation/storage.py src/lease/storage.py src/lease/service.py src/knowledge/storage.py src/knowledge/service.py tests/persistence/test_runtime_domain_persistence_s59.py tests/lease/test_lease_api.py tests/knowledge/test_knowledge_api.py tests/launch/test_ga_rehearsal_s52.py tools/launch/rehearse_ga_candidate.py
pytest -q tests/persistence/test_runtime_domain_persistence_s59.py tests/lease/test_lease_api.py tests/knowledge/test_knowledge_api.py tests/marketplace/test_marketplace_api.py tests/marketplace/test_procurement_controls_s45.py tests/compliance/test_compliance_controls_s47.py tests/federation/test_gateway.py tests/federation/test_enterprise_pack_s46.py tests/launch/test_ga_rehearsal_s52.py
pytest -q tests/integration/test_registry_api.py::test_latency_p95_thresholds
pytest -q
npm run e2e
```

## Test Results
- Passed:
  - `28 passed` targeted persistence/marketplace/procurement/compliance/federation/lease/knowledge/launch bundle.
  - `1 passed` latency p95 threshold check (`tests/integration/test_registry_api.py::test_latency_p95_thresholds`).
  - `190 passed` full pytest regression suite.
  - `8 passed` Playwright e2e suite.
- Failed: `0` (final run)
- Skipped: `0`

## Verification Evidence
- Persistence conversion coverage:
  - runtime domains now use SQLite collection store with scope+collection namespaced payload persistence.
  - legacy `*_PATH` fixture files bootstrap into SQLite on first read when a collection is empty.
- Durability checks:
  - `tests/persistence/test_runtime_domain_persistence_s59.py` validates domain data remains accessible after deleting seeded legacy JSON files.
  - lease and knowledge state survive module reloads in the same db-backed runtime path.
- Performance regression closure:
  - initial full-suite run exposed `p95 read` latency regression in `test_latency_p95_thresholds`.
  - fixed by adding connection reuse and collection-level read cache in `src/common/sqlite_collections.py`.
  - verified passing latency threshold test afterward.
- End-to-end validation:
  - commercial, operator/versioning, and customer-ui Playwright flows all remain passing with migrated runtime env configuration.

## Known Risks
- SQLite collection cache is process-local and optimized for single-process runtime; distributed deployment still requires shared database architecture decisions.
- Legacy path bootstrap is one-way ingest by design; active runtime writes now target SQLite only.

## Next Segment Handoff
- Recommended next segment: `S60` (security fail-closed wave: enforce-mode defaults, legacy secret fallback removal where remaining, procurement fail-closed behavior when policy pack is missing).
- Required context for next segment:
  - Remaining major product-completion gaps are security posture hardening, protocol adapter completeness, and runtime orchestration depth.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
