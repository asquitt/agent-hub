# Evidence

## Segment
- ID: S53
- Deliverable(s): Architectural remediation Phase 0/1/2/4/5 foundations
- Date: 2026-02-13

## Code Changes
- Files changed:
  - `src/api/access_policy.py`
  - `src/api/app.py`
  - `src/api/auth.py`
  - `src/api/store.py`
  - `src/discovery/index.py`
  - `src/discovery/service.py`
  - `src/federation/gateway.py`
  - `src/idempotency/__init__.py`
  - `src/idempotency/storage.py`
  - `src/registry/__init__.py`
  - `src/registry/catalog.py`
  - `db/migrations/runtime/idempotency/0001_idempotency_requests.sql`
  - `tests/conftest.py`
  - `tests/delegation/test_delegation_api.py`
  - `tests/auth/test_access_enforcement_s53.py`
  - `tests/gate/test_architecture_guardrails_s53.py`
  - `docs/session-packets/S53.md`
- Summary:
  - Added route classification and access enforcement middleware with `warn|enforce` compatibility behavior, tenant claim validation, deprecation warning header support, and metering audit events.
  - Removed hardcoded-secret fallback behavior for enforce mode in auth/federation paths by requiring env-backed configuration (`AGENTHUB_API_KEYS_JSON`, `AGENTHUB_AUTH_TOKEN_SECRET`, `AGENTHUB_FEDERATION_DOMAIN_TOKENS_JSON`).
  - Added persistent SQLite idempotency subsystem and middleware-level reservation/replay logic for mutating endpoints, including stable missing-key/conflict error codes.
  - Replaced API runtime dependency on tooling mock capability engine with canonical discovery service-backed capability search/match/recommend/list behavior.
  - Added billing invoice and marketplace contract/dispute/payout read authorization checks.
  - Added discovery index tenant/visibility awareness and reduced registry list path N+1 version loading.
  - Added architecture guardrail tests (route policy snapshot + import boundaries) and enforce-mode security/idempotency tests.

## Test Commands Executed
```bash
python -m py_compile src/api/app.py src/api/auth.py src/api/access_policy.py src/api/store.py src/discovery/index.py src/discovery/service.py src/federation/gateway.py src/idempotency/storage.py src/registry/catalog.py
pytest -q tests/integration/test_registry_api.py tests/discovery/test_discovery_api.py tests/delegation/test_delegation_api.py tests/tenancy/test_registry_tenant_isolation.py
pytest -q tests/auth/test_access_enforcement_s53.py tests/gate/test_architecture_guardrails_s53.py tests/integration/test_registry_api.py tests/discovery/test_discovery_api.py tests/delegation/test_delegation_api.py tests/tenancy/test_registry_tenant_isolation.py
pytest -q
```

## Test Results
- Passed:
  - `27 passed` on focused registry/discovery/delegation/tenancy regression suite.
  - `37 passed` on guardrail + focused regression bundle.
  - `180 passed, 2 warnings` on full regression suite.
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- Access enforcement:
  - Enforce-mode matrix validates unauthenticated `401`, tenant spoof `403`, and authorized tenant `200` (`tests/auth/test_access_enforcement_s53.py`).
  - Warn-mode compatibility returns `X-AgentHub-Deprecation-Warn` for missing idempotency key while preserving success response (`tests/auth/test_access_enforcement_s53.py`).
- Idempotency:
  - Persistent replay verified for billing subscription writes with `X-AgentHub-Idempotent-Replay=true`.
  - Same key + different payload returns `409` with deterministic code `idempotency.key_reused_with_different_payload`.
  - Delegation contention path is non-blocking with in-progress conflicts (`409`) validated in updated storm test.
- Architecture guardrails:
  - Route policy map snapshot test and hash guard in `tests/gate/test_architecture_guardrails_s53.py`.
  - Import boundary guard prevents non-API direct `tools/*` imports and direct `src.api` imports (except explicit bridge module).

## Known Risks
- Full persistence unification across remaining JSON/in-memory runtime domains is not complete in this segment.
- Startup lifecycle still uses deprecated `@app.on_event("startup")`; migration to lifespan hooks remains pending.

## Next Segment Handoff
- Recommended next segment: `S54` (runtime persistence unification wave: marketplace/procurement/compliance/federation/trust/eval/lease/knowledge).
- Required context for next segment:
  - Access, idempotency, and architecture guardrails are in place and passing.
  - Remaining highest-risk gap is fragmented persistence outside registry/delegation/billing/idempotency stores.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
