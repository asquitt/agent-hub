# Evidence

## Segment
- ID: S36
- Deliverable(s): Delegation durability
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `db/migrations/runtime/delegation/0002_delegation_durability.sql`
  - `src/delegation/storage.py`
  - `src/delegation/service.py`
  - `src/api/app.py`
  - `tests/delegation/test_delegation_api.py`
  - `tests/persistence/test_delegation_persistence.py`
  - `docs/delegation/DELEGATION_PROTOCOL.md`
  - `docs/session-packets/S36.md`
- Summary:
  - Added durable delegation idempotency and queue-state tables/migrations.
  - Replaced delegation endpoint in-memory replay handling with persistent reservation/finalization flow.
  - Added pending-replay wait path and retry reservation behavior for duplicate request storms.
  - Persisted delegation queue-state transitions (`queued`, `running`, settlement status) with attempt counters.
  - Added restart durability and storm replay tests plus snapshot/restore persistence tests for new state.

## Test Commands Executed
```bash
pytest tests/delegation/test_delegation_api.py -q
pytest tests/persistence/test_delegation_persistence.py -q
pytest tests/delegation/test_contract_v2.py tests/cost_governance/test_metering_integration.py tests/operator/test_operator_ui.py -q
pytest -q
```

## Test Results
- Passed:
  - `9 passed in 0.42s` (delegation API)
  - `3 passed in 0.06s` (delegation persistence)
  - `7 passed in 0.41s` (delegation compatibility bundle)
  - `130 passed in 5.87s` (full regression)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- Durable idempotency:
  - `test_delegation_idempotency_replay_survives_runtime_reconfigure` validates replay persistence after storage reconfigure.
  - `test_delegation_idempotency_storm_returns_single_durable_response` validates duplicate storm dedupe with a single delegation record.
- Queue/orchestration durability:
  - Queue state transitions and attempt counts are returned on delegation responses/status and persisted in DB.
  - `test_delegation_idempotency_and_queue_state_persist_through_snapshot_restore` validates snapshot restore parity for idempotency+queue state.
- Contract/backward compatibility:
  - Existing delegation contract and metering/operator integration suites remain green.

## Known Risks
- Pending idempotency entries are currently bounded by wait timeout and manual retry behavior; stale-pending cleanup policy is not yet automated.
- Queue-state model currently captures coarse lifecycle states and should expand if deeper worker-state introspection is needed.

## Next Segment Handoff
- Recommended next segment: `S37` (Reliability/SRE controls)
- Required context for next segment:
  - Add circuit-breaker governance and error-budget SLO metrics on top of persistent delegation/runtime events introduced through S36.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
