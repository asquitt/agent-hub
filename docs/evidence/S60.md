# Evidence

## Segment
- ID: S60
- Deliverable(s): Security fail-closed hardening wave (auth/config defaults + procurement deny-by-default + enforce-mode compatibility)
- Date: 2026-02-13

## Code Changes
- Security default + configuration validation hardening:
  - `src/api/access_policy.py`
  - `src/api/auth.py`
  - `src/api/app.py`
  - `src/federation/gateway.py`
  - `src/federation/__init__.py`
  - `src/provenance/service.py`
  - `src/provenance/__init__.py`
  - `src/procurement/service.py`
- Launch runtime compatibility under strict idempotency/auth:
  - `src/launch/readiness.py`
  - `src/launch/rehearsal.py`
- Test/runtime harness updates for strict enforcement:
  - `tests/conftest.py`
  - `playwright.config.js`
  - `tests/auth/test_security_fail_closed_s60.py`
  - `tests/auth/test_identity_v2.py`
  - `tests/billing/test_billing_api.py`
  - `tests/capability_search/test_search_v2.py`
  - `tests/compliance/test_compliance_controls_s47.py`
  - `tests/cost_governance/test_metering_integration.py`
  - `tests/delegation/test_delegation_api.py`
  - `tests/devhub/test_collaboration_v2_s43.py`
  - `tests/discovery/test_discovery_api.py`
  - `tests/discovery/test_live_indexing_s34.py`
  - `tests/federation/test_gateway.py`
  - `tests/federation/test_enterprise_pack_s46.py`
  - `tests/integration/test_registry_api.py`
  - `tests/knowledge/test_knowledge_api.py`
  - `tests/lease/test_lease_api.py`
  - `tests/marketplace/test_marketplace_api.py`
  - `tests/marketplace/test_marketplace_finance_v2_s44.py`
  - `tests/marketplace/test_procurement_controls_s45.py`
  - `tests/operator/test_operator_ui.py`
  - `tests/tenancy/test_registry_tenant_isolation.py`
  - `tests/versioning/test_behavioral_diff.py`
- Summary:
  - Default access mode now fail-closed `enforce` unless explicitly overridden to `warn`.
  - API key map and auth token secret are required at startup; legacy permissive auth fallback removed.
  - Federation domain-token config is required and validated; legacy domain fallback removed.
  - Provenance signing secret is required and validated.
  - Procurement now denies purchases when no active policy pack exists.
  - Access middleware maps unauthenticated events to `401` and forbidden/authz boundary violations to `403`.
  - Test suite and launch rehearsal flows were updated to provide required auth and idempotency headers under strict defaults.

## Test Commands Executed
```bash
pytest -q tests/auth/test_security_fail_closed_s60.py tests/marketplace/test_marketplace_api.py tests/marketplace/test_marketplace_finance_v2_s44.py tests/marketplace/test_procurement_controls_s45.py tests/federation/test_gateway.py tests/federation/test_enterprise_pack_s46.py tests/auth/test_access_enforcement_s53.py tests/operator/test_operator_ui.py tests/provenance/test_provenance_signing_s40.py
pytest -q tests/auth/test_identity_v2.py tests/billing/test_billing_api.py tests/capability_search/test_search_v2.py tests/compliance/test_compliance_controls_s47.py tests/cost_governance/test_metering_integration.py tests/delegation/test_delegation_api.py tests/devhub/test_collaboration_v2_s43.py tests/discovery/test_discovery_api.py tests/discovery/test_live_indexing_s34.py tests/integration/test_registry_api.py tests/knowledge/test_knowledge_api.py tests/lease/test_lease_api.py tests/launch/test_launch_readiness.py tests/launch/test_ga_rehearsal_s52.py tests/tenancy/test_registry_tenant_isolation.py tests/versioning/test_behavioral_diff.py
pytest -q
npm run e2e
```

## Test Results
- Passed:
  - `40 passed` targeted S60/security bundle.
  - `61 passed` focused remediation suite covering previously failing domains.
  - `194 passed` full `pytest -q` regression suite.
  - `8 passed` Playwright e2e suite.
- Failed: `0` (final runs)
- Skipped: `0`

## Verification Evidence
- Fail-closed startup behavior verified:
  - Missing `AGENTHUB_API_KEYS_JSON` or `AGENTHUB_AUTH_TOKEN_SECRET` now fails app startup.
  - Missing `AGENTHUB_FEDERATION_DOMAIN_TOKENS_JSON` now fails app startup.
  - Missing `AGENTHUB_PROVENANCE_SIGNING_SECRET` now fails app startup.
- Default access enforcement verified:
  - Unauthenticated protected routes now return `401` in enforce mode by default.
  - Authenticated-but-unauthorized boundaries return `403`.
- Procurement fail-closed verified:
  - Purchases without active policy packs are denied with explicit policy-pack-required audit reason.
- Launch/readiness regression closure:
  - Rehearsal and demo flows now include required idempotency/auth headers and pass again under strict defaults.

## Known Risks
- Stricter defaults can break legacy clients/tests until they supply auth and idempotency headers consistently.
- Environment bootstrapping for local/dev must include all required secrets and token maps; startup intentionally hard-fails otherwise.

## Next Segment Handoff
- Recommended next focus:
  1. Expand structured ABAC policy model beyond owner/tenant/admin boundaries.
  2. Add startup diagnostics endpoint/docs for missing required env values to reduce integration friction.
  3. Add conformance tests for third-party adapters to ensure strict auth/idempotency requirements remain uniform.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
