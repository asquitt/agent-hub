# Evidence

## Segment
- ID: S58
- Deliverable(s): Customer UI lockdown, lifespan migration, router decomposition foundation, strict CI gate
- Date: 2026-02-13

## Code Changes
- Added customer UI runtime policy helpers:
  - `src/api/customer_ui_policy.py`
- Added shared operator helper extraction:
  - `src/api/operator_helpers.py`
- Added router foundation package and endpoint extraction:
  - `src/api/routes/__init__.py`
  - `src/api/routes/system.py`
  - `src/api/routes/operator.py`
  - `src/api/routes/customer.py`
- Updated app wiring:
  - `src/api/app.py`
    - lifespan startup validation (`validate_auth_configuration()` via `asynccontextmanager`)
    - router includes for system/operator/customer foundation
- Hardened customer UI:
  - `src/ui/customer_journey.html`
    - removed prefilled API keys
    - added warning banner
    - disabled full demo button until required key fields are present
- Updated Playwright harness + customer tests:
  - `playwright.config.js`
  - `e2e/playwright/customer-ui.spec.js`
- Updated operator/lifecycle/customer hardening tests:
  - `tests/operator/test_operator_ui.py`
- Replaced CI workflow with strict quality gates:
  - deleted `.github/workflows/playwright-e2e.yml`
  - added `.github/workflows/quality-gates.yml`
- Updated documentation:
  - `README.md`
  - `docs/DELIVERABLE_LOG.md`

## Test Commands Executed
```bash
python3 -m py_compile src/api/app.py src/api/access_policy.py src/api/routes/system.py src/api/routes/operator.py src/api/routes/customer.py
pytest tests/operator/test_operator_ui.py tests/gate/test_architecture_guardrails_s53.py -q
pytest tests/auth/test_access_enforcement_s53.py tests/operator/test_operator_ui.py tests/gate/test_architecture_guardrails_s53.py -q
npm run e2e
```

## Test Results
- `py_compile`: passed.
- `pytest` (operator + guardrail): `14 passed`.
- `pytest` (security/operator/guardrail targeted gate set): `21 passed`.
- Playwright e2e suite: `8 passed`.
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- `/customer` security behavior verified by tests:
  - default disabled -> `404`
  - enabled + no auth -> `401`
  - enabled + unauthorized owner -> `403`
  - enabled + allowlisted owner -> `200`
- Customer UI source verified without prefilled key defaults.
- Lifespan startup migration verified:
  - enforce mode starts with required auth env config
  - enforce mode fails startup when required auth env config is missing
  - no `on_event` startup deprecation warning assertion in targeted test run
- Route policy guardrail snapshot remained stable and passing.
- Operator UI/API role-boundary tests remained passing.
- Playwright customer flow executes successfully with explicit `/customer` enable + auth env in test harness.

## Known Risks
- `/customer` remains a demo workflow surface and should stay disabled in production by default.
- Branch protection enforcement of required checks is a manual GitHub repository setting.

## Next Segment Handoff
- Recommended next focus:
  1. Continue router decomposition for additional domains while preserving route policy snapshot stability.
  2. Add `/customer` access telemetry dashboards (401/403/404 breakdown) for staging observability.
  3. Promote strict branch protection settings and audit repository configuration drift.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
