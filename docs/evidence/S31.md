# Evidence

## Segment
- ID: S31
- Deliverable(s): Tenancy and namespace isolation
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `db/migrations/runtime/registry/0002_tenant_scope.sql`
  - `src/api/store.py`
  - `src/api/app.py`
  - `tests/tenancy/test_registry_tenant_isolation.py`
  - `docs/session-packets/S31.md`
- Summary:
  - Added tenant_id columns/indexes for registry namespaces and agents.
  - Extended registry store APIs with tenant-aware reservation, CRUD, version listing, and query filtering.
  - Added tenant scoping in agent APIs via `X-Tenant-ID` with deterministic default tenant.
  - Added idempotency cache keys scoped by tenant to prevent cross-tenant idempotency collisions.
  - Added cross-tenant denial tests for read/update/delete and tenant-scoped namespace/list visibility.

## Test Commands Executed
```bash
pytest tests/tenancy/test_registry_tenant_isolation.py tests/integration/test_registry_api.py tests/versioning/test_behavioral_diff.py tests/launch/test_launch_readiness.py -q
pytest -q
```

## Test Results
- Passed:
  - `17 passed in 2.26s` (tenant + registry impacted suites)
  - `119 passed in 6.44s` (full regression)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API/contract validation:
  - Existing registry API tests remain green with default tenant behavior.
- Tenant boundary validation:
  - Cross-tenant get/update/delete attempts return `404` in `tests/tenancy/test_registry_tenant_isolation.py`.
  - Tenant-scoped listing and namespace queries return isolated datasets.
- Reliability validation:
  - Full regression remains green after tenant keying and API header propagation changes.

## Known Risks
- Namespace identifiers are still globally unique; tenant-local namespace duplication remains future enhancement scope.
- Tenant scoping is complete for the registry path in this segment; full subsystem parity is staged for later segments.

## Next Segment Handoff
- Recommended next segment: `S32` (Identity v2)
- Required context for next segment:
  - Bind tenant resolution to stronger identity claims and scoped token issuance.
  - Maintain backwards compatibility for existing API key workflow during transition.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
