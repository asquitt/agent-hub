# Evidence

## Segment
- ID: S30
- Deliverable(s): Metering and billing ledger
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `db/migrations/runtime/billing/0001_billing_ledger.sql`
  - `src/billing/storage.py`
  - `src/billing/service.py`
  - `src/billing/__init__.py`
  - `src/cost_governance/storage.py`
  - `tests/billing/test_billing_api.py`
  - `tests/billing/test_ledger_v2.py`
  - `tests/cost_governance/test_metering_integration.py`
  - `tests/federation/test_gateway.py`
  - `tests/marketplace/test_marketplace_api.py`
  - `docs/billing/BILLING_FLOW.md`
  - `docs/session-packets/S30.md`
- Summary:
  - Added runtime billing migration with persistent subscription, usage, invoice, immutable ledger, and metering tables.
  - Added billing storage layer and refactored billing service to ledger-backed reconciliation and replay checks.
  - Added immutable ledger enforcement using SQLite triggers preventing update/delete.
  - Extended metering storage to persistent DB-backed implementation with legacy JSON bootstrap support.
  - Added dedicated S30 tests for double-entry integrity, replay parity drift detection, and immutability protections.

## Test Commands Executed
```bash
pytest tests/billing/test_billing_api.py tests/billing/test_ledger_v2.py -q
pytest tests/billing tests/cost_governance -q
pytest -q
```

## Test Results
- Passed:
  - `5 passed in 0.48s` (billing API + ledger v2 targeted)
  - `10 passed in 0.32s` (billing + cost governance grouped verification)
  - `117 passed in 6.13s` (full regression)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API/contract validation:
  - Existing billing endpoints remained compatible and continued passing API tests.
- Double-entry integrity:
  - Verified via `tests/billing/test_ledger_v2.py::test_double_entry_integrity_for_usage_invoice_and_refund`.
- Replay parity:
  - Verified mismatch detection via tampered invoice payload in `tests/billing/test_ledger_v2.py::test_reconciliation_replay_parity_detects_tampered_invoice`.
- Immutability:
  - Trigger-level rejection of ledger updates/deletes validated by `tests/billing/test_ledger_v2.py::test_ledger_entries_are_immutable`.
- Migration evidence:
  - Billing migration recorded in `_schema_migrations` and asserted in test suite.

## Known Risks
- SQLite-backed persistence is sufficient for S30 foundation but not final HA architecture for production-scale billing.
- Ledger hash-chain validation is local-process and should be paired with signed export/attestation in later trust/compliance segments.

## Next Segment Handoff
- Recommended next segment: `S31` (Tenancy and namespace isolation)
- Required context for next segment:
  - Add tenant identity propagation and query scoping over new persistent stores.
  - Add cross-tenant negative tests for registry/delegation/billing paths.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
