# Evidence

## Segment
- ID: S45
- Deliverable(s): Procurement controls
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `.gitignore`
  - `src/procurement/storage.py`
  - `src/procurement/service.py`
  - `src/procurement/__init__.py`
  - `src/marketplace/service.py`
  - `src/api/models.py`
  - `src/api/app.py`
  - `tests/marketplace/test_marketplace_api.py`
  - `tests/marketplace/test_marketplace_finance_v2_s44.py`
  - `tests/marketplace/test_procurement_controls_s45.py`
  - `docs/policy/PROCUREMENT_CONTROLS_S45.md`
  - `docs/session-packets/S45.md`
- Summary:
  - Added persistent procurement storage for policy packs, approvals, exceptions, and audit events.
  - Implemented procurement service workflows for policy-pack management, approval request/decision, exception issuance, and purchase policy evaluation.
  - Enforced procurement controls in marketplace purchase flow with approval/exception references and persisted procurement decision context on contracts.
  - Added procurement API models and endpoints for policy packs, approvals, exceptions, and audit visibility.
  - Added S45 end-to-end tests for policy boundary enforcement, admin approval/exception boundaries, and scoped audit access.

## Test Commands Executed
```bash
pytest tests/marketplace/test_marketplace_api.py tests/marketplace/test_marketplace_finance_v2_s44.py tests/marketplace/test_procurement_controls_s45.py -q
pytest tests/integration/test_registry_api.py tests/cost_governance/test_metering_integration.py tests/policy/test_runtime_policy.py -q
pytest -q
```

## Test Results
- Passed:
  - `9 passed in 0.49s` (marketplace + finance + S45 procurement tests)
  - `17 passed in 2.56s` (integration/cost/policy bundle)
  - `153 passed in 7.65s` (full regression)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- Policy boundary enforcement:
  - Purchases above auto-approval threshold require approved procurement approval.
  - Purchases above hard-stop threshold are denied without a valid procurement exception.
  - Seller allowlist boundaries are enforced by procurement policy pack evaluation.
- Authorization boundaries:
  - Non-admin actors cannot decide procurement approvals.
  - Non-admin actors cannot create procurement exceptions.
  - Non-admin actors cannot query audit data for other buyers.
- Auditability:
  - Policy-pack upsert, approval lifecycle, exception creation, and purchase evaluation emit procurement audit events.
  - Procurement actions emit metering operations for operator/billing visibility.

## Known Risks
- Approval workflow is single-step and does not yet support multi-stage approval chains or quorum requirements.
- Exception lifecycle currently supports creation and expiry, but explicit revoke/attest workflow is deferred.

## Next Segment Handoff
- Recommended next segment: `S46` (Federation enterprise pack)
- Required context for next segment:
  - Procurement controls now provide enterprise budget and approval boundaries that can be referenced by federated policy propagation and attestation exports.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
