# Evidence

## Segment
- ID: S18
- Deliverable(s): Capability Search v2
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `tools/capability_search/mock_engine.py`
  - `tools/capability_search/benchmark.py`
  - `tools/capability_search/benchmark_dataset_s18.json`
  - `data/capability_search/s18_benchmark_results.json`
  - `specs/capability-search/openapi-capability-search-v0.1.yaml`
  - `tests/capability_search/test_search_v2.py`
  - `tests/capability_search/test_openapi_contract.py`
  - `docs/capability-search/ranking-algorithm.md`
  - `docs/session-packets/S18.md`
- Summary:
  - Upgraded capability search with v2 ranking mode (default), while preserving policy-first filtering before ranking.
  - Added deterministic explainability payload in search responses:
    - `explainability.why_selected`
    - `explainability.why_rejected`
    - `explainability.ranking_mode`
  - Added rejection reason taxonomy for policy and semantic exclusions.
  - Added benchmark dataset and script to compare `baseline` vs `v2` ranking quality.
  - Updated OpenAPI contract to include explainability schemas and search response fields.
  - Added S18 verification tests for explainability, malformed query handling, benchmark improvement, and latency budget.

## Test Commands Executed
```bash
pytest tests/capability_search/test_query_scenarios.py tests/capability_search/test_openapi_contract.py tests/capability_search/test_search_v2.py tests/integration/test_registry_api.py -q
python3 tools/capability_search/benchmark.py --dataset tools/capability_search/benchmark_dataset_s18.json --output data/capability_search/s18_benchmark_results.json
```

## Test Results
- Passed:
  - `28 passed` in capability-search + registry integration suites.
  - Benchmark completed with improved metrics:
    - `top1_accuracy_delta = +0.166667`
    - `mrr_delta = +0.111111`
    - `top3_accuracy_delta = 0.0` (no regression)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API contract validation:
  - OpenAPI search response now explicitly models explainability structures in `SearchResponse`, `SearchExplainability`, and related reason schemas.
  - `tests/capability_search/test_openapi_contract.py` passed with explainability assertions.
- Security validation:
  - Search engine enforces policy-first gating and records deterministic rejection reasons for denied candidates (`policy.required_permissions`, `policy.min_trust_score`, etc.).
  - `tests/capability_search/test_search_v2.py::test_search_v2_policy_rejection_reasons_are_exposed` passed.
- Cost/latency validation:
  - Search latency check passed in repeated query run with `p95 < 120ms` target (`tests/capability_search/test_search_v2.py::test_search_v2_latency_budget`).
- Screenshots/log excerpts:
  - `pytest ... -q` output: `28 passed in 1.89s`
  - Benchmark output persisted at `data/capability_search/s18_benchmark_results.json`.

## Known Risks
- Benchmark dataset is deterministic and small; broader relevance validation still requires production telemetry and larger real-world query corpora.
- v2 ranking currently relies on lexical/synonym heuristics rather than embedding-based semantics; this is acceptable for deterministic local validation but not final production quality.

## Next Segment Handoff
- Recommended next segment: S19
- Required context for next segment:
  - Runtime policy output from S17 is already integrated in discovery/delegation/install.
  - Search v2 now emits explainability and benchmark artifacts that can be referenced in delegation contract selection heuristics.
  - `tools/capability_search/benchmark.py` provides baseline vs v2 scoring pattern for future regression gates.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
