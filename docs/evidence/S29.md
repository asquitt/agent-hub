# Evidence

## Segment
- ID: S29
- Deliverable(s): Persistence foundation
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `src/persistence/migrations.py`
  - `src/persistence/__init__.py`
  - `db/migrations/runtime/registry/0001_registry_foundation.sql`
  - `db/migrations/runtime/delegation/0001_delegation_foundation.sql`
  - `src/api/store.py`
  - `src/delegation/storage.py`
  - `tests/persistence/test_registry_persistence.py`
  - `tests/persistence/test_delegation_persistence.py`
  - `tests/integration/test_registry_api.py`
  - `tests/delegation/test_delegation_api.py`
  - `tests/delegation/test_contract_v2.py`
  - `tests/operator/test_operator_ui.py`
  - `tests/cost_governance/test_metering_integration.py`
  - `tests/versioning/test_behavioral_diff.py`
  - `tests/launch/test_launch_readiness.py`
  - `docs/session-packets/S29.md`
- Summary:
  - Added migration scaffolding with per-scope migration tracking (`_schema_migrations`) and runtime SQL migration folders.
  - Replaced registry in-memory store with SQLite-backed persistent implementation while preserving API-level behavior and idempotency cache semantics.
  - Replaced delegation JSON storage path with SQLite-backed persistence plus one-time legacy JSON import path for backward compatibility.
  - Added restart persistence + snapshot recovery tests for registry and delegation.
  - Updated impacted test fixtures to isolate registry/delegation DBs per test run.

## Test Commands Executed
```bash
pytest tests/persistence/test_registry_persistence.py tests/persistence/test_delegation_persistence.py tests/integration/test_registry_api.py tests/delegation/test_delegation_api.py tests/delegation/test_contract_v2.py tests/operator/test_operator_ui.py tests/cost_governance/test_metering_integration.py tests/versioning/test_behavioral_diff.py tests/launch/test_launch_readiness.py -q
pytest -q
```

## Test Results
- Passed:
  - `33 passed in 2.29s` (targeted S29 + impacted suites)
  - `113 passed in 7.68s` (full regression suite)
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API/contract validation:
  - Registry/delegation endpoints retain existing behavior under persistent backends (regression suites passed).
- Migration validation:
  - Runtime migrations tracked in `_schema_migrations` and asserted in persistence tests for both scopes.
  - Legacy delegation JSON import path validated by `test_delegation_storage_migrates_legacy_json_on_first_boot`.
- Recovery validation:
  - Snapshot backup/restore recovery tests added and passing:
    - `test_registry_store_snapshot_restore_recovers_prior_state`
    - `test_delegation_storage_persists_and_restores_from_snapshot`
- Reliability validation:
  - Existing idempotency and lifecycle delegation tests remain green after storage swap.

## Known Risks
- SQLite durability is a valid foundation for this segment but not final HA strategy for multi-node production.
- Idempotency cache remains in-memory; persistent idempotency materialization can be hardened in subsequent segments where required.

## Next Segment Handoff
- Recommended next segment: `S30` (Metering and billing ledger)
- Required context for next segment:
  - Build immutable ledger model and reconciliation primitives on top of current persistent foundation.
  - Keep migration discipline using `db/migrations/runtime/*` and `_schema_migrations`.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
