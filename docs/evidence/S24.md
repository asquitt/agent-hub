# Evidence

## Segment
- ID: S24
- Deliverable(s): Lease-to-Install Promotion Flow
- Date: 2026-02-12

## Code Changes
- Files changed:
  - `src/api/models.py`
  - `src/lease/service.py`
  - `src/lease/__init__.py`
  - `src/api/app.py`
  - `tests/lease/test_lease_api.py`
  - `tests/cost_governance/test_metering_integration.py`
  - `docs/lease/LEASE_PROMOTION.md`
  - `docs/session-packets/S24.md`
- Summary:
  - Extended lease promotion flow with explicit approval and compatibility checks:
    - `approval_ticket` required (`APR-*` pattern)
    - `compatibility_verified=true` required
  - Added persistent install records with `install_id` at promotion time.
  - Added owner-scoped rollback endpoint:
    - `POST /v1/capabilities/installs/{install_id}/rollback`
  - Added rollback metering event emission.
  - Added tests for compatibility denial, successful promotion, and rollback integrity.

## Test Commands Executed
```bash
pytest tests/lease tests/cost_governance/test_metering_integration.py tests/federation/test_gateway.py -q
pytest tests/integration/test_registry_api.py tests/operator/test_operator_ui.py tests/delegation/test_delegation_api.py -q
```

## Test Results
- Passed:
  - `10 passed` in lease/cost/federation suite.
  - `21 passed` in integration/operator/delegation regression suite.
- Failed: `0`
- Skipped: `0`

## Verification Evidence
- API contract validation:
  - Promotion request schema now enforces approval ticket + compatibility fields.
  - Rollback request schema introduced (`LeaseRollbackRequest`).
- Security validation:
  - Compatibility bypass is denied:
    - `test_lease_promotion_requires_compatibility_and_supports_rollback` (first promotion attempt).
  - Owner boundaries retained on lease/install operations.
- Cost/latency validation:
  - Rollback path emits metering event (`capabilities.install_rollback`) and keeps responses deterministic.
  - No latency regressions observed in local suite.
- Screenshots/log excerpts:
  - `pytest tests/lease ... -q` -> `10 passed in 0.33s`
  - `pytest tests/integration ... -q` -> `21 passed in 2.17s`

## Known Risks
- Install records remain in-memory for this phase; persistent multi-node install registry is deferred.
- Compatibility verification is currently explicit boolean contract input, not an automated dependency solver.

## Next Segment Handoff
- Recommended next segment: S25
- Required context for next segment:
  - S24 now provides promotion + rollback safety controls needed for marketplace alpha transaction lifecycle constraints.

## Mandatory Confirmation
- [x] `docs/agenthub-master-plan-v1.2.docx` updated
- [x] `docs/DELIVERABLE_LOG.md` updated
